---
title: 'Assessing Safety, Adherence, and Pharmacokinetics in the MATIK Trial'
author: "Baoyi Shi & Robert Tumasian"
date: "March 29, 2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#load libraries
library(tidyverse)
library(patchwork)

#load data
bl.data=read.csv("baseline.csv")[,-c(1,3:5)]
endpt.data=read.csv("endpoints.csv")
```

```{r}
#merge and tidy data (NO MISSINGNESS, n=30 in each of the 6 sequences)
all.data=merge(endpt.data,bl.data,by="ptid") %>%
  mutate(sequence1=factor(ifelse(period1=="Pill A" & period2=="Gel B" & period3=="Gel C",1,
                  ifelse(period1=="Gel C" & period2=="Pill A" & period3=="Gel B",2,
                  ifelse(period1=="Gel B" & period2=="Gel C" & period3=="Pill A",3,
                  ifelse(period1=="Gel B" & period2=="Pill A" & period3=="Gel C",4,
                  ifelse(period1=="Pill A" & period2=="Gel C" & period3=="Gel B",5,6)))))),
         sequence2=factor(ifelse(sequence1==1 | sequence1==4,0,
                          ifelse(sequence1==2 | sequence1==5,1,2)))) %>%
  pivot_longer(cols=AE_pillA_week1:Adhere_gelC_week4,names_to=c("AE.or.Adhere","trt","week"),
               names_pattern="(..)_(.*)_(.*)",values_to="AE.or.adhere.val") %>%
  mutate(AE.or.Adhere=ifelse(AE.or.Adhere=="re","Adhere","AE"),
         week=str_sub(week,5,-1))

View(all.data)
```

```{r}
#PRIMARY OBJECTIVES (safety and adherence)

#Safety
ae.plot1=all.data %>%
  dplyr::filter(AE.or.Adhere=="AE") %>%
  dplyr::select(trt,AE.or.adhere.val,week) %>%
  ggplot(aes(x=week,y=AE.or.adhere.val))+
  geom_histogram(stat="identity")+
  facet_grid(.~trt)+
  labs(y="No. of grade 2 or higher AEs",x="Week")

ae.plot2=all.data %>%
  dplyr::filter(AE.or.Adhere=="AE") %>%
  dplyr::select(trt,AE.or.adhere.val,week,sequence1) %>%
  ggplot(aes(x=week,y=AE.or.adhere.val))+
  geom_histogram(stat="identity")+
  facet_grid(.~sequence1)+
  labs(y="No. of grade 2 or higher AEs",x="Week")

ae.plot1/ae.plot2
```

```{r}

#Adherence (ACROSS ALL 6 SEQUENCES)
adherence.plot1=all.data %>%
  dplyr::filter(AE.or.Adhere=="Adhere") %>%
  dplyr::select(trt,AE.or.adhere.val,week) %>%
  ggplot(aes(x=week,y=AE.or.adhere.val))+
  geom_histogram(stat="identity")+
  facet_grid(.~trt)+
  labs(y="Days of adherence",x="Week")

adherence.plot2=all.data %>%
  dplyr::filter(AE.or.Adhere=="Adhere") %>%
  dplyr::select(trt,AE.or.adhere.val,week,sequence1) %>%
  ggplot(aes(x=week,y=AE.or.adhere.val))+
  geom_histogram(stat="identity")+
  facet_grid(.~sequence1)+
  labs(y="Days of adherence",x="Week")

adherence.plot1/adherence.plot2
```


```{r}
#SECONDARY OBJECTIVES (pharmacokinetics and demographic differences)

```

